digraph {
    node [style="filled", fontsize="24pt"]

    subgraph terminals {
        node [shape="ellipse", fillcolor="yellow"]

        Source [label="CHMMM source"]
        LLVM [label="LLVM assembly"]
    }

    subgraph data {
        node [shape="parallelogram"]

        subgraph orangeData {
            node [fillcolor="orange"]

            ASTErrors [label="AST errors"]
            FillingErrors [label="Type instantiation\nerrors"]
            ManglingErrors [label="Mangling\nerrors"]
            UnifyErrors [label="Unification\nerrors"]
            BlockifierErrors [label="Blockifier\nerrors"]
            MonomorphizeErrors [label="Monomorphization\nerrors"]
            VariablesErrors [label="Variable collecton\nerrors"]
            LeftFacts [label="Leftover\nconstraints"]
        }
        subgraph greenData {
            node [fillcolor="lightgreen"]

            AST
            Facts [label="Type constraints"]
            Variables [label="Variables"]
            ASTTypeElabs [label="AST\nwith elaborations"]
            Judgments [label="Type assigments"]
            FlatAST [label="Flat AST"]
            BlockifiedAST [label="Blockified AST"]
            BlockifiedASTAnnots [label="Blockified AST\nwith analyzed flow"]
            MonoAST [label="Monomorphized AST\nwith type elaborations"]
            FilledMonoAST [label="Monomorphized AST\nwith instantiated types"]
            PostAST [label="Postprocessed AST\nthat can be translated"]
        }

    }

    subgraph components {
        node [shape="component"]

        subgraph greenComponents {
            node [fillcolor="lightblue"]

            FunDepSimpl [label="Functional dependencies\nsimplifier"]
            Parser [label="Tokenizer + Lexer"]
            Flattener
            Preprocess [label="Type inference\npreprocessing"]
            VariableMining [label="Variable collection\n(repeated)"]
            Blockifier
            FlowAnalysis [label="Flow analysis"]
            Inference [label="Type inference"]
            Monomorphization
            ElabFilling [label="elaboration filling"]
            Mangling
            Translator
        }
    }


    Source -> Parser -> AST
    AST -> Flattener -> FlatAST
    VariableMining -> VariablesErrors
    AST -> VariableMining -> Variables -> Preprocess
    Facts -> FunDepSimpl
    ASTTypeElabs -> Monomorphization
    FunDepSimpl -> Inference -> Judgments -> Monomorphization -> MonoAST -> ElabFilling -> FilledMonoAST -> Mangling -> PostAST
    ElabFilling -> FillingErrors
    Mangling -> ManglingErrors
    { Inference Monomorphization } -> UnifyErrors
    FlatAST -> Blockifier -> {BlockifiedAST BlockifierErrors }
    BlockifiedAST -> FlowAnalysis -> BlockifiedASTAnnots
    FlowAnalysis -> BlockifierErrors
    BlockifiedASTAnnots -> Preprocess -> { Facts ASTTypeElabs }
    Monomorphization -> MonomorphizeErrors
    { FillingErrors ManglingErrors UnifyErrors BlockifierErrors MonomorphizeErrors VariablesErrors LeftFacts } -> ASTErrors
    Inference -> LeftFacts
    PostAST -> Translator -> LLVM
}
